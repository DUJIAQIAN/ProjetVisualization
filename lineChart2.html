<html>
  <head>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="./lib/PapaParse-4.6.0/papaparse.min.js"></script>
  </head>

  <body>
    <div id="chart"></div>
  </body>

<script>

var width = 900;
var height = 500;
var margin = 50;
var duration = 250;

var lineOpacity = "0.25";
var lineOpacityHover = "0.85";
var otherLinesOpacityHover = "0.1";
var lineStroke = "1.5px";
var lineStrokeHover = "2.5px";

var circleOpacity = '0.85';
var circleOpacityOnLineHover = "0.25"
var circleRadius = 3;
var circleRadiusHover = 6;


Papa.parse('./data_v4.csv', {
  download: true,
  header: true,
  dynamicTyping: true,
  fastmode:true,
  complete: function(results) {
      var data = results.data;
      //console.log(data);
      

      let nest_annee = d3.nest()
          .key(function(d){return d.Annee})
          .object(data);
      //console.log(nest_annee)

      let nest_mois = d3.nest()
          .key(function(d){return d.Date})
          .sortKeys(d3.ascending)
          .rollup(function(v) { return v.length; })
          .entries(nest_annee["2017"]);

      console.log(nest_mois);


      /* Format Data */
    var parseDate = d3.timeParse("%Y-%m");
    nest_mois.forEach(function(d) { 
        d.key = parseDate(d.key);
        d.value = +d.value;
    });


/* Scale */
var xScale = d3.scaleTime()
  .domain(d3.extent(nest_mois, d => d.key))
  .range([0, width-margin]);

var yScale = d3.scaleLinear()
  .domain([0, d3.max(nest_mois, d => d.value)])
  .range([height-margin, 0]);

var color = d3.scaleOrdinal(d3.schemeCategory10);

/* Add SVG */
var svg = d3.select("#chart").append("svg")
  .attr("width", (width+margin)+"px")
  .attr("height", (height+margin)+"px")
  .append('g')
  .attr("transform", `translate(${margin}, ${margin})`);


/* Add line into SVG */
var line = d3.line()
  .x(d => xScale(d.key))
  .y(d => yScale(d.value))
  .curve(d3.curveMonotoneX);

var linePath = svg.append("path")
.datum(nest_mois)
.attr("fill", "none")
.attr("stroke", "steelblue")
.attr("stroke-linejoin", "round")
.attr("stroke-linecap", "round")
.attr("stroke-width", 1.5)
.attr("d", line);

var linePathLength = linePath.node().getTotalLength();
linePath
    .attr("stroke-dasharray", linePathLength)
    .attr("stroke-dashoffset", linePathLength)
    .transition()
        .duration(4000)
        .ease(d3.easeLinear)
        .attr("stroke-dashoffset", 0);

/* Add circle */ 
var circle = svg.selectAll("dot").data(nest_mois)
  .enter()
  .append("circle")
  .attr("r", 8)
  .style("fill", "grey")
  .attr("cx", function(d){return xScale(d.key)})
  .attr("cy", function(d){return yScale(d.value);})
  .attr("class", "dot")
  .on("mouseover", function(d) {	
      d3.select(this).transition().duration(100)
        .style("fill", "black")
        .attr("r", 8);	
      })			
    
  .on("mouseout", function(d) {	
      d3.select(this).transition().duration(100)
        .style("fill", "grey")
        .attr("r", 5);
  });

/* Add Axis into SVG */
var xAxis = d3.axisBottom(xScale).ticks(5);
var yAxis = d3.axisLeft(yScale).ticks(5);

svg.append("g")
  .attr("class", "x axis")
  .attr("transform", `translate(0, ${height-margin})`)
  .call(xAxis);

svg.append("g")
  .attr("class", "y axis")
  .call(yAxis)
  .append('text')
  .attr("y", 15)
  .attr("transform", "rotate(-90)")
  .attr("fill", "#000")
  .text("DÃ©claration de perte");
  }
});
</script>
</html>